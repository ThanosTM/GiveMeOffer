## 1、主要有哪几种内核锁？Linux内核的同步机制是什么？
- 内核锁：最基础的是自旋锁与信号量。其中自旋锁在等待时将忙等，不会引起调用者睡眠，直到自旋锁持有者释放了锁，适合短时间持有；信号量在等待时将挂起，将自己放到该信号量的等待队列中，并且信号量不能用于ISR中，因为ISR不能睡眠。
- 内核同步机制：原子操作、内存屏障、自旋锁、读写锁、顺序锁、信号量、RCU.

## 2、用户态与内核态
用户模式是受限模式，对硬件的访问都需要通过系统调用来实现，用户应用程序运行在用户态；内核态是一种高权限模式，能够直接访问硬件。

## 3、怎样申请内核内存？
- vmalloc()用于内核申请大块内存，特点是线性地址连续，但物理地址未必连续，释放函数为vfree()；
- kmalloc()用于申请小块内存，基于slab分配器实现，slab分配器是针对分配小内存所设计的一种高效机制，特定是线性地址连续，物理地址连续，释放函数为kfree()；

## 4、用户进程间通信主要方式？
- 管道：亲缘关系进程间通信
- 命名管道：无亲缘进程间通信，在文件系统中有对应的文件名，使用mkfifo创建；
- 信号：通知接收进程有某种事件发生，包含了Unix早期信号、POSIX标准信号等；
- 消息队列：有写权限的进程向队列添加消息，读权限的进程可以读走消息，克服了信号承载信息少，克服了管道的无格式字节流；
- 共享内存：最快的IPC形式，往往与信号量结合使用，达到进程间的同步与互斥；
- 信号量：进程间或线程间的同步手段；
- 套接字：更为一般的进程间通信机制，可以用于不同主机；

==（另开笔记学习）==

## 5、通过伙伴系统申请内存的函数有哪些？
在==物理页面==管理上实现了基于区的伙伴系统（zone based buddy system），对于不同的区使用单独的伙伴系统管理，并且独立地监控空闲页。相应接口为：
- alloc_pages(gfp_mask, order);
- __get_free_pages(gfp_mask, order);

Linux内核引入伙伴系统是为了解决这种问题：当经常需要分配一组连续的页框时，频繁地分配和释放不同大小的连续页框会造成空闲页框碎片，即使这些碎片是空闲的，也很难满足其他需要分配连续页框的应用；Linux将所有空闲页框划分为11个链表，每个链表包含大小为1/2/4/.../1024个连续页框的页框块，最大可以申请1024个连续页框即4MB的内存空间；分配时进行必要的拆分，释放时进行必要的合并；

## 6、通过slab分配器申请内核内存的函数有哪些？
`kmem_cache_create()`和`kmem_cache_alloc()`是基于slab分配器的一种内存分配方式，适用于反复分配释放同一大小的内存块，首先用`kmem_cache_create()`创建一个高速缓存区域，然后用`kmem_cache_alloc()`从该高速缓存区域中获取新的内存块。slab分配器为每种使用的内核对象建立单独的缓冲区，Linux内核已经采用了伙伴系统管理物理页框，因此slab分配器建立在伙伴系统之上，每个缓冲区由多个slab组成，每个slab就是一组连续的物理内存页框，被划分成固定数目的对象。处于对齐、填充等其他因素的考虑，slab中会出现一定的内存浪费。

## 7、Linux内核空间和用户空间是如何划分的？
对于32位机，一共是4G的虚拟地址空间，Linux内核将其划分成两部分，用户空间（0~0xBFFFFFFF），内核空间（0xC0000000~0xFFFFFFFF）；每个用户进程可以通过系统调用进入内核，Linux内核由所有进程共享；虽然内核空间占据了每个虚拟空间最高的1GB，但映射到物理内存却总是从最低地址开始的，对内核空间来说，其地址映射总是很简单的线性映射（？？？）

## 8、vmalloc()申请的内存有什么特点？
大块内存，线性地址连续，物理地址未必连续，不能用于DMA；

## 9、用户程序malloc()申请的内存空间在什么范围？
用户空间的堆；

## 10、Linux与MMU
Linux内核和用户程序均运行在虚拟地址模式，对于没有MMU的系统实际上用户空间和内核空间是不做区分的，uClinux与标准Linux的区别就在于内存管理，标准Linux是针对有MMU的处理器设计的，而对于uClinux则针对没有MMU的处理器设计，不能使用虚拟内存管理技术。

## 11、ARM处理器是通过几级页表进行存储空间映射的？
ARM处理器采用两级页表进行地址映射：
- 一级页表包含以段为单位的地址变换条目或者指向二级页表的指针，一级页表实现的地址映射粒度较大；
- 二级页表中分类有大页、小页和极小页为单位的地址变换条目；

## 12、Linux是通过什么组件来实现支持多种文件系统的？
虚拟文件系统（Virtual File System，VFS），是Linux内核的一个软件层，用于给用户程序提供文件系统接口，同时给内核提供了一个抽象功能，允许不同的文件系统共存，系统中的所有文件系统不但依赖VFS共存，而且能够依靠VFS协同工作。

## 13、Linux虚拟文件系统的关键数据结构有哪些？
- `struct super_block`：超级块对象存储一个已安装的文件系统的控制信息，代表一个已安装的文件系统；
- `struct inode`：索引结点存储了文件的相关信息，代表了存储设备上的一个实际的物理文件，当一个文件首次被访问时，内核会在内存中组装相应的索引结点对象，以便向内核提供对一个文件操作时所必须的全部信息；
- `struct dentry`：目录项，没有对应的磁盘数据结构，VFS在遍历路径名的过程中现场将他们逐个解析成目录项，目录项的概念主要是为了方便查找文件。
- `struct file`：文件对象是已打开文件在内存中的表示，主要用于建立进程和磁盘上文件的对应关系。

## 14、对文件或设备的操作函数存放在哪个数据结构中？
`struct file_operation`

## 15、Linux中文件包含哪些？
可执行文件、普通文件、目录文件、链接文件、设备文件、管道文件

## 16、创建进程的系统调用有哪些？
clone()、fork()、vfork()具体看其他笔记。

## 17、调用schedule()进行进程切换的方式有几种？
- 系统调用do_fork()；
- 定时器中断do_timer()；
- 唤醒进程wake_up_process()；
- 改变进程的调度策略setscheduler()；
- 系统调用礼让sys_sched_yield()；

## 18、Linux内核中的浮点运算由应用程序实现还是内核？
由应用程序实现，Linux中的浮点运算由数学库函数实现，库函数能够被应用程序链接后调用，不能被内核链接调用。linux内核如果一定要进行浮点运算，需要在建立内核时选上math-emu，使用软件模拟浮点运算；这么做的代价有：用户在安装驱动时需要重建内核，且效率很低。

## 19、如何加载、卸载一个模块
insmod加载，rmmod卸载，modprobe会根据模块的依赖关系自动加载所有模块，若载入过程中发生错误则将卸载整组的模块。

## 20、Linux中有哪几种设备？
字符设备、块设备，网卡是例外，它不直接与设备文件相对应，mknod()系统调用用来创建设备文件。

## 21、字符设备驱动程序的关键数据结构是？
字符设备描述符`struct cdev`，`cdev_alloc()`用于动态分配cdev描述符，`cdev_add()`注册一个cdev描述符，cdev包含一个`struct kobject`类型的数据结构，它是设备驱动程序的核心数据结构。

## 22、设备驱动程序包含哪些功能函数？
`open()`、`read()`、`write()`、`ioctl()`、`release()`

## 23、如何唯一标识一个设备？
Linux使用设备号来唯一标识一个设备，设备号分为两个部分，主设备号与次设备号，一般主设备号标识设备对应的驱动程序，次设备号用于确定设备文件指向的设备。在内核使用数据结构`dev_t`标识设备编号，一般为32位长度，其中12位为主设备号，后20位为次设备号。函数MKDEV(int major, int minor)用于生成一个dev_t类型的对象。

## 24、Linux通过什么方式实现系统调用？
靠软件中断实现。x86系统中软件中断由int指令实现，这个指令会导致一个异常，会使得处理器切换到内核态并跳转到一个新的地址，开始执行那里的异常处理程序。

## 25、Linux软中断和工作队列的作用是什么？
- 软中断一般是可延迟函数的总称，不能阻塞、不能睡眠，处于中断上下文中，不能进程切换，软中断不能被自己打断，只能被硬件中断打断，可以并发运行在多个CPU中，因此软中断函数必须是可重入函数，也需要自旋锁来保护其数据结构。
- 工作队列处于进程上下文中，可以睡眠、可以阻塞，能够在不同进程间切换，以完成不同的工作。