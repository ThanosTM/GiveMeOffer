## 伙伴系统原理
Linux内存管理是一项重要的工作，面对频繁的内存申请与释放，内核需要采用灵活恰当的分配策略；内存分配具有两种情况：大的连续空间分配、小的空间分配。

#### 内存碎片问题
###### 内部碎片
已经分配出去的但却不能被利用的内存空间，例如一个进程请求3K字节的内存空间，但是Linux内核伙伴算法最小颗粒是4K，于是1K未被使用的就是内部碎片。

###### 外部碎片
还没有被分配出去，但是由于自身太小了无法分配给新进程的申请。随着申请和释放的次数增加，内存变得越来越不连续，即外部碎片，从而不能够满足一个大块的连续内存。

#### 伙伴系统原理
Linux采用伙伴系统来解决外部碎片的问题，==宗旨是用最小的内存来满足内核对于内存的需求==。
![image](https://img-blog.csdnimg.cn/20200610215949452.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTI0ODkyMzY=,size_16,color_FFFFFF,t_70#pic_center)

###### 数据结构
空闲块按大小和起始地址组织成二维数组，初始只有一个大小为2^u的空闲块

###### 分配过程
由小到大在空闲块数组中找最小的可用空闲块，如果空闲块过大，则对可用块进行二等分，直到得到最小的合适块。

###### 释放过程
把释放的块放入空闲数组，合并满足条件的空闲块，过程如下：大小相同2^i，地址相邻，低地址空闲块起始地址为2^(i+1)的位数

#### 优缺点
###### 优点
针对大内存设计，较好地解决了外部碎片问题，只要申请的块不超过1024个页面（4M），内核将尽量分配连续的页面。

###### 缺点
合并的要求过于严格，一个很小的块往往会阻挡很大的块的合并；分配的块为2的幂，某些情况下会造成可观的空间浪费；拆分和合并的开销比较大

#### 总结：Linux==针对大内存的物理地址分配==，采用伙伴算法，如果是针对小于一个page的内存，频繁的分配和释放，有更加适宜的解决方案，如slab

## Linux伙伴系统的设计思路
![image](https://img-blog.csdnimg.cn/2020070622550251.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTI0ODkyMzY=,size_16,color_FFFFFF,t_70#pic_center)

内核将系统的空闲页面分成11个块链表，每个块链表分别管理着2^0，2^1，2^2...2^10个物理页帧号，对应着4K到4M.

#### 以链表连接内存块
![image](https://img-blog.csdnimg.cn/20200706225527174.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTI0ODkyMzY=,size_16,color_FFFFFF,t_70#pic_center)

在struct free_area中，struct list_head free_list[MIGRATE_TYPES]是一个数组，元素是一个链表头，每个链表挂载着2^i大小的连续页面；因此伙伴不必是彼此连续的，系统工作时：
- 低阶连续页面不足时，将高阶内存在分配器件拆成两半，内核自动将未用的一半加入对应的链表
- 由于内存释放的缘故，当两个内存区都处于空闲状态，可以通过地址判断其是否为伙伴，是则进行合并。

#### 避免内部碎片
系统在长期运行后，物理内存将产生很多碎片，例如最大的连续空闲区只有一页的大小。虽然这对于用户进程而言无关紧要，因为只需要设置好页表项，应用程序看到的虚拟内存空间总是连续的；但对于内核而言，大部分物理内存都是一致映射到地址空间的内核部分，有时候需要分配多于一页大小的内存块时，将导致失败。

对此Linux采用两类解决方案：
- 依据可移动性组织页
- 虚拟可移动内存域

###### 依据可移动性组织页
- 文件系统也有碎片，但可以通过碎片合并工具进行解决，但是许多物理内存页不能移动到任意位置，==Linux内核采用的方法是反碎片化==，试图从最开始尽可能防止碎片。

- 内核将已分配的页划分为以下3种类型：
1. 不可移动页：内核分配的大多数属于该类
2. 可移动页：可以随意移动，用户空间的应用程序分配的内存属于该页，因为只需要修改对应的页表项即可完成自动映射。
3. 可回收页：例如映射至文件的数据属于该类型，kswapd守护进程会周期性地根据可回收页的访问频繁程度，周期性的释放此类内存。

- 根据类的可移动性将页框分配到不同的列表中，有助于减少碎片。


#### 其他
对于申请单个页框，系统会从每个CPU的高速缓存维护的单个页框链表中进行分配；而对于申请多个页框，系统则从伙伴系统中进行分配，可以说每个CPU的高速缓存算是伙伴系统的一部分，专门用于分配单个 页框，因为系统希望尽量让那些刚释放掉的单个页框分配出去，这样有效的提高缓存命中率，因为释放掉的页框可能还处于缓存中，而杠分配的页框一般都会马上使用，系统就不用对这些页框进行换入换出缓存了
